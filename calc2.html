<html>
  <body style="margin: 0; background: black;">
    <div style="text-align: center;">
      <canvas id="canvas"></canvas>
    </div>
    <script src="dm.js"></script>
    <script>

'use strict';

debug = false;

class CalcObj extends Rectangle {
  constructor(x, y, color, optInput) {
    super(x, y, 50, 50, color);
    this.operands = [];
    this.acceptInput(optInput !== undefined ? optInput : '() => {}');
  }

  acceptInput(str) {
    const parts = /([a-zA-Z0-9_]+):(.*)/.exec(str);
    if (parts === null) {
      this.setValueFnFromString(str);
      this.labelStr = str;
    } else {
      this.setValueFnFromString(parts[2]);
      this.setLabelFromString(parts[1]);
    }
  }

  setValueFnFromString(str) {
    return this.setValueFn(eval(str));
  }

  setValueFn(fn) {
    if (typeof fn !== 'function') {
      const val = fn;
      fn = () => val;
    }
    this.valueFn = fn;
    let argNames = fn.toString().split('=>')[0].replace(/[\(\)\ ]/g, '').split(',');
    if (argNames.length === 1 && argNames[0].length === 0) {
      argNames = [];
    }
    const hasRestArg = argNames.length > 0 && argNames[argNames.length - 1].startsWith('...');
    this.minArity = Math.max(0, hasRestArg ? argNames.length - 1 : argNames.length);
    this.maxArity = hasRestArg ? Infinity : this.minArity;
  }

  setLabelFromString(str) {
    try {
      const fn = eval(str);
      if (typeof fn === 'function') {
        this.labelFn = fn;
      }
    } catch (e) {}
    this.labelStr = str;
  }

  get label() {
    return this.labelFn ? this.labelFn(this.value) : this.labelStr;
  }

  async step() {
    this.value = undefined;
    const responses = await this.to.left(200).upTo(this.maxArity).send('ping');
    this.operands = responses.map(response => response.receiver);
    if (this.operands.length >= this.minArity) {
      const values = this.operands.map(operand => operand.value);
      this.value = values.some(value => value === undefined) ?
          undefined :
          this.valueFn(...values);
    }

    const label = this.label;
    ctxt.font = '12pt Monaco';
    this.width = 30 + ctxt.measureText(label).width;
    this.height = Math.max(50 * Math.max(this.minArity, 1), this.operands.length * 50);
  }

  drawUnderOn(ctxt, options) {
    for (let operand of this.operands) {
      ctxt.strokeStyle = 'yellow';
      ctxt.moveTo(this.x, this.y);
      ctxt.lineTo(operand.x, operand.y);
      ctxt.stroke();
    }
  }

  drawOn(ctxt, options) {
    super.drawOn(ctxt, options);
    ctxt.font = '12pt Monaco';
    ctxt.fillStyle = 'yellow';
    const text = this.label;
    const x = this.x - ctxt.measureText(text).width / 2;
    const y = this.y + 6;
    ctxt.fillText(text, x, y);
  }
}

objects = [
  new CalcObj(100, 120, 'cornflowerblue', '1'),
  new CalcObj(100, 180, 'steelblue', '5'),
  new CalcObj(200, 150, 'indigo', 'plus: (a, b) => a + b'),
  new CalcObj(300, 150, 'maroon', 'a => a')
];

    </script>
  </body>
</html>
