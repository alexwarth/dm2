<html>
  <body style="margin: 0; background: black;">
    <div style="text-align: center;">
      <canvas id="canvas"></canvas>
    </div>
    <script src="dm.js"></script>
    <script src="Database.js"></script>
    <script>

'use strict';

const db = new Database(
  ['C1', 'is a', 'circle', 'at', '(', 300, ',', 300, ')'],
  ['C1', '\'s', 'color', 'is', 'cornflowerblue'],
  ['C1', '\'s', 'radius', 'is', 50],
  ['R1', 'is a', 'rectangle', 'at', '(', 150, ',', 150, ')'],
  ['R1', '\'s', 'width', 'is', 50],
  ['R1', '\'s', 'height', 'is', 100],
  ['R1', '\'s', 'color', 'is', 'salmon'],
);

class Orchestrator extends Rectangle {
  constructor(...processes) {
    super(20, 20, 30, 30, 'indigo')
    this.processes = processes
  }

  async step(t) {
    objects = [this, ...this.processes];
  }

  addProcess(name, color, fn) {
    const lastObj = this.processes.length === 0 ?
        this :
        this.processes[this.processes.length - 1];
    const process = new Rectangle(20, lastObj.y + 40, 30, 30, color);
    process.name = name;
    process.step = fn;
    this.processes.push(process);
  }
}

const orchestrator = new Orchestrator();
objects.push(orchestrator);

orchestrator.addProcess(
  'circle illuminator',
  'steelblue',
  () => {
    db.query(
      [
        ['$c', 'is a', 'circle', 'at', '(', '$x', ',', '$y', ')'],
        ['$c', '\'s', 'radius', 'is', '$r'],
        ['$c', '\'s', 'color', 'is', '$color'],
      ],
      ({$x, $y, $r, $color}, facts, assert, retract) => {
        const c = new Circle($x, $y, $r, $color);
        c.fact = facts[0];
        objects.push(c);
      }
    );
  });

orchestrator.addProcess(
  'rectangle illuminator',
  'salmon',
  () => {
    db.query(
      [
        ['$r', 'is a', 'rectangle', 'at', '(', '$x', ',', '$y', ')'],
        ['$r', '\'s', 'width', 'is', '$w'],
        ['$r', '\'s', 'height', 'is', '$h'],
        ['$r', '\'s', 'color', 'is', '$color'],
      ],
      ({$x, $y, $w, $h, $color}, facts, assert, retract) => {
        const r = new Rectangle($x, $y, $w, $h, $color)
        r.fact = facts[0];
        objects.push(r);
      }
    )
  });

orchestrator.addProcess(
  'object labeler',
  'lightyellow',
  () => {
    db.query(
      [
        ['$c', 'is a', '$t', 'at', '(', '$x', ',', '$y', ')'],
      ],
      ({$c, $x, $y, $h}, facts, assert, retract) => {
        const rectangle = new Rectangle($x, $y, 0, 0, 'black')
        rectangle.fact = facts[0]
        rectangle.drawOn = () => {}
        rectangle.drawOverOn = context => {
          context.fillStyle = 'lightyellow'
          context.fillText($c, $x, $y - 10)
        }
        objects.push(rectangle)
      }
    )
  });

let targetObjId = null;

let nextIdNum = 1;
function makeNewId() {
  return 'obj#' + nextIdNum++;
}

const colors = ['cornflowerblue', 'steelblue', 'maroon', 'yellow', '#ccc'];
function randomColor() {
  return colors[Math.floor(Math.random() * Math.floor(colors.length))];
}

let mouseButtonFact = null;

document.body.addEventListener('mousedown', e => {
  db.retract(mouseButtonFact);
  mouseButtonFact = ['mouse', 'button', 'is', 'down'];
  db.assert(mouseButtonFact);

  if (e.altKey) {
    const obj = makeNewId();
    const facts = [
      [obj, 'is a', 'circle', 'at', '(', mouse.x, ',', mouse.y, ')'],
      [obj, '\'s', 'radius', 'is', 50 + (Math.random() - .5) * 20],
      [obj, '\'s', 'color', 'is', randomColor()]
    ];
    db.assert(...facts);
  } else if (e.metaKey) {
    const obj = makeNewId();
    const facts = [
      [obj, 'is a', 'rectangle', 'at', '(', mouse.x, ',', mouse.y, ')'],
      [obj, '\'s', 'width', 'is', 50 + (Math.random() - .5) * 20],
      [obj, '\'s', 'height', 'is', 50 + (Math.random() - .5) * 20],
      [obj, '\'s', 'color', 'is', randomColor()]
    ];
    db.assert(...facts);
  } else {
    targetObjId = mouse.targetObj && mouse.targetObj.fact && mouse.targetObj.fact[0];
  }
  console.log('-----');
  console.log(db.toString());
});

let mousePosFact = null;

document.body.addEventListener('mousemove', e => {
  db.retract(mousePosFact);
  mousePosFact = ['mouse', 'is', 'at', '(', mouse.x, ',', mouse.y, ')'];
  db.assert(mousePosFact);

  if (targetObjId) {
    db.query(
      [[targetObjId, 'is a', '$t', 'at', '(', '$x', ',', '$y', ')']],
      ({targetObjId, $t, $x, $y}, facts, assert, retract) => {
        retract(facts[0]);
        const newFact = facts[0].slice();
        newFact[5] = mouse.x;
        newFact[7] = mouse.y;
        assert(newFact);  // TODO: don't want provenance here!
      });
  }

  console.log('-----');
  console.log(db.toString());
});

document.body.addEventListener('mouseup', e => {
  db.retract(mouseButtonFact);
  mouseButtonFact = ['mouse', 'button', 'is', 'up'];
  db.assert(mouseButtonFact);
  targetObjId = null;
  console.log('-----');
  console.log(db.toString());
});

    </script>
  </body>
</html>
