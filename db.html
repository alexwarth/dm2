<html>
  <body style="margin: 0; background: black;">
    <div style="text-align: center;">
      <canvas id="canvas"></canvas>
    </div>
    <script src="dm.js"></script>
    <script src="Database.js"></script>
    <script>

'use strict';

const db = new Database(
  ['C1', 'is a', 'circle', 'at', '(', 300, ',', 300, ')'],
  ['C1', '\'s', 'color', 'is', 'cornflowerblue'],
  ['C1', '\'s', 'radius', 'is', 50],
  ['R1', 'is a', 'rectangle', 'at', '(', 150, ',', 150, ')'],
  ['R1', '\'s', 'width', 'is', 50],
  ['R1', '\'s', 'height', 'is', 100],
  ['R1', '\'s', 'color', 'is', 'salmon'],
);

class Orchestrator extends Rectangle {
  constructor(...processes) {
    super(20, 20, 30, 30, 'indigo')
    this.processes = processes
  }

  async step(t) {
    objects = [this, ...this.processes];
  }
}

class CircleIlluminator extends Rectangle {
  constructor() {
    super(60, 20, 30, 30, 'steelblue')
  }

  async step(t) {
    db.query(
      [
        ['$c', 'is a', 'circle', 'at', '(', '$x', ',', '$y', ')'],
        ['$c', '\'s', 'radius', 'is', '$r'],
        ['$c', '\'s', 'color', 'is', '$color'],
      ],
      (vars, facts, assert, retract) => {
        const c = new Circle(vars.$x, vars.$y, vars.$r, vars.$color);
        c.fact = facts[0];
        objects.push(c);
      }
    );
  }
}

class ObjectLabeller extends Rectangle {
  constructor() {
    super(20, 100, 30, 30, 'lightyellow')
  }

  async step(t) {
    db.query(
      [
        ['$c', 'is a', '$t', 'at', '(', '$x', ',', '$y', ')'],
      ],
      ({$c, $x, $y, $h}, facts, assert, retract) => {
        const rectangle = new Rectangle($x, $y, 20, 20, 'steelblue')
        rectangle.drawOn = () => {}
        rectangle.drawOverOn = (context) => {
          console.log(`drawing label`)
          context.fillStyle = 'lightyellow'
          context.fillText($c, $x, $y - 10)
        }
        objects.push(rectangle)
      }
    )
  }
}

class RectIlluminator extends Rectangle {
  constructor() {
    super(20, 60, 30, 30, 'salmon')
  }

  async step(t) {
    db.query(
      [
        ['$r', 'is a', 'rectangle', 'at', '(', '$x', ',', '$y', ')'],
        ['$r', '\'s', 'width', 'is', '$w'],
        ['$r', '\'s', 'height', 'is', '$h'],
        ['$r', '\'s', 'color', 'is', '$color'],
      ],
      ({$x, $y, $w, $h, $color}, facts, assert, retract) => {
        const r = new Rectangle($x, $y, $w, $h, $color)
        r.fact = facts[0];
        objects.push(r);
      }
    )
  }
}

const rectangle_illuminator = new RectIlluminator();
const circle_illuminator = new CircleIlluminator();
const object_labeler = new ObjectLabeller();

const orchestrator = new Orchestrator(rectangle_illuminator, circle_illuminator, object_labeler);
objects.push(orchestrator);

let targetObjFact = null;

let nextIdNum = 1;
function makeNewId() {
  return 'obj#' + nextIdNum++;
}

const colors = ['cornflowerblue', 'steelblue', 'maroon', 'yellow', '#ccc'];
function randomColor() {
  return colors[Math.floor(Math.random() * Math.floor(colors.length))];
}

document.body.addEventListener('mousedown', e => {
  if (e.altKey) {
    const obj = makeNewId();
    const facts = [
      [obj, 'is a', 'circle', 'at', '(', mouse.x, ',', mouse.y, ')'],
      [obj, '\'s', 'radius', 'is', 50 + (Math.random() - .5) * 20],
      [obj, '\'s', 'color', 'is', randomColor()]
    ];
    db.assert(...facts);
    console.log('---');
    console.log(db.toString());
  } else if (e.metaKey) {
    const obj = makeNewId();
    const facts = [
      [obj, 'is a', 'rectangle', 'at', '(', mouse.x, ',', mouse.y, ')'],
      [obj, '\'s', 'width', 'is', 50 + (Math.random() - .5) * 20],
      [obj, '\'s', 'height', 'is', 50 + (Math.random() - .5) * 20],
      [obj, '\'s', 'color', 'is', randomColor()]
    ];
    db.assert(...facts);
    console.log('---');
    console.log(db.toString());
  } else {
    targetObjFact = mouse.targetObj && mouse.targetObj.fact;
  }
});

document.body.addEventListener('mousemove', e => {
  if (!targetObjFact) {
    return;
  }
  // Could just modify fact in place, but that's an optimization
  // and optimizations are evil.
  db.retract(targetObjFact);
  targetObjFact = targetObjFact.slice();
  targetObjFact[5] = mouse.x;
  targetObjFact[7] = mouse.y;
  db.assert(targetObjFact);
  console.log('-----');
  console.log(db.toString());
});

document.body.addEventListener('mouseup', e => {
  targetObjFact = null;
});

    </script>
  </body>
</html>
